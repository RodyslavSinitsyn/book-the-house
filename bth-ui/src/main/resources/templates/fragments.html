<!--head elements fragment-->
<th:block th:fragment="commonHead">
    <meta charset="UTF-8"/>
    <meta name="csrf-header" th:content="${_csrf.headerName}">
    <meta name="csrf-token" th:content="${_csrf.token}">
    <meta name="firebase-api-key" th:content="${firebaseApiKey}">
    <meta name="firebase-vapid-key" th:content="${firebaseVapidKey}">
    <link th:href="@{/css/main.css}" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,line-clamp"></script>
    <script th:src="@{/js/header.js}" type="text/javascript"></script>
    <script th:src="@{/js/logout.js}" th:if="${isAuth}" type="text/javascript"></script>
    <script th:src="@{/js/csrf.js}" type="text/javascript"></script>
    <script th:src="@{/js/fcm.js}" th:if="${isAuth}" type="module"></script>
</th:block>

<!--header fragment-->
<header class="bg-white shadow-md p-4">
    <div class="container mx-auto flex items-center justify-between">
        <!-- Left Section: Logo -->
        <div class="text-2xl font-bold text-blue-600">
            <a href="/posts">Book the House</a>
        </div>

        <!-- Center Section: Tabs -->
        <nav class="hidden md:flex space-x-8" th:if="${isAuth}">
            <a href="/posts" class="text-gray-700 hover:text-blue-600">Posts</a>
            <a href="/subscriptions" class="text-gray-700 hover:text-blue-600">Subscriptions</a>
            <a href="/chat/list" class="text-gray-700 hover:text-blue-600">Chats</a>
        </nav>

        <!-- Right Section: User Info -->
        <div class="relative flex items-center space-x-4">
            <!-- Conditional Login/Profile Button -->
            <a id="loginButton" href="/login" class="text-blue-600 hover:bg-blue-100 px-4 py-2 rounded-full"
               th:if="${!isAuth}">
                Login
            </a>

            <!-- Avatar and Username -->
            <span class="text-sm" th:if="${isAuth}"
                  th:text="${#authentication.fullName}">John Doe</span>
            <div class="relative"
                 th:if="${isAuth}"
                 th:with="pictureUrl=${#authentication.avatarUrl}">
                <!-- Avatar Image (Clickable) -->
                <img id="header-avatar"
                     th:if="${pictureUrl != null}"
                     th:src="${pictureUrl}"
                     alt="User Avatar"
                     class="w-8 h-8 rounded-full cursor-pointer">

                <!-- Dropdown Menu -->
                <div id="header-dropdown-menu"
                     class="absolute right-0 hidden mt-2 w-40 bg-white shadow-lg rounded-lg z-10">
                    <ul>
                        <li>
                            <a href="/profile" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Profile</a>
                        </li>
                        <li>
                            <a href="/logout" onclick="logout()"
                               class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Logout</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div id="info-popup" class="fixed top-5 right-5 bg-blue-500 text-white text-lg font-semibold px-6 py-3 rounded-lg shadow-lg transform translate-x-full opacity-0 transition-all duration-300 ease-in-out">
        This is a notification!
    </div>
</header>

<!-- Footer fragment -->
<footer class="bg-gradient-to-r from-blue-100 via-blue-300 to-blue-500 text-white text-center py-4 mt-auto">
    <div class="container mx-auto">
        <!-- Copyright -->
        <p>&copy; 2025 rsinitsyn. All rights reserved.</p>

        <!-- Social Links -->
        <div class="flex justify-center space-x-4 my-2">
            <a href="https://www.linkedin.com/in/rodyslav-sinitsyn-68493a1a1/" class="text-white" target="_blank" rel="noopener noreferrer">LinkedIn</a>
            <a href="https://github.com/RodyslavSinitsyn" class="text-white" target="_blank" rel="noopener noreferrer">GitHub</a>
        </div>

        <!-- Contact Info -->
        <p class="my-2">Email: <a href="mailto:radik200058@gmail.com" class="text-white hover:underline">radik200058@gmail.com</a></p>
    </div>
</footer>

<th:block th:fragment="noRecords">
    <div class="no-records flex items-center justify-center h-48">
        <div class="bg-gray-100 text-gray-600 text-lg font-medium px-6 py-3 rounded-lg shadow-sm">
            No records so far...
        </div>
    </div>
</th:block>

<!-- postList fragment -->
<th:block th:fragment="postList(posts)">
    <!-- Post Cards -->
    <div class="space-y-6">
        <div th:each="post : ${posts}">
            <!-- Use the postCard fragment for each post -->
            <div th:replace="~{fragments :: postCard(post=${post})}"></div>
        </div>
    </div>
</th:block>

<!-- postCard fragment -->
<th:block th:fragment="postCard(post)">
    <div class="post-card fadeIn-container max-w-3xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden border border-gray-300">
        <img th:src="'http://localhost:8082/api/v1/download/' + ${post.imageUrl}" alt="Post Image"
             class="w-full h-64 object-cover">
        <div class="p-6">
            <h2 class="text-xl font-bold text-gray-800 truncate" th:text="${post.title}">Post Title</h2>
            <p class="text-base text-gray-600 mt-3 line-clamp-3" th:text="${post.details.description}">
                This is a description of the post. It might get a bit longer, but it will be trimmed after a few lines
                to make it neat...
            </p>
            <p class="text-base text-gray-500 mt-4"
               th:text="${post.location.country} + ', ' + ${post.location.state} + ', ' + ${post.location.city}">
                Country, State, City
            </p>
            <p class="text-base text-gray-500 mt-2">
                <strong>
                    <span th:text="${post.details.availableFrom}"></span> / <span
                        th:text="${post.details.availableTo}"></span>
                </strong>
            </p>
            <p class="text-base mt-3 line-clamp-3"
               th:with="isMyPost=${isAuth && #authentication.fullName == post.username}"
               th:classappend="${(isMyPost ? 'bg-blue-500' : '') + ' ' + (isMyPost ? 'text-white' : 'text-black-600')}"
               th:text="${isMyPost ? 'My publication' : 'Posted by: ' + post.friendlyName}">
                Posted by
            </p>
            <div class="flex items-center justify-between mt-6">
                <span class="text-2xl font-bold text-blue-500" th:text="${post.details.price} + '$'">$123</span>
                <a th:href="@{/posts/details/{id}(id=${post.id})}"
                   th:if="${hideDetails == null || !hideDetails}"
                   class="text-lg px-6 py-3 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">
                    Details
                </a>
            </div>
        </div>
    </div>
</th:block>

<th:block th:fragment="postsFilter">
    <aside class="posts-filter w-full md:w-1/3 bg-white shadow-lg rounded-lg p-6 border border-gray-300 flex-shrink-0">
        <h2 class="text-xl font-semibold text-gray-800 mb-4" th:if="${isAuth}">Create</h2>
        <form th:action="@{/post}" enctype="multipart/form-data" method="POST" th:if="${isAuth}">
            <div class="mb-4">
                <label for="postImage" class="block text-gray-600 font-medium mb-1">Image</label>
                <input
                        type="file"
                        id="postImage"
                        name="file"
                        placeholder="Upload image"
                        class="w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300 focus:outline-none"
                />
            </div>
            <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition">
                Publish
            </button>
        </form>

        <!-- Divider -->
        <hr class="my-6 border-gray-300" th:if="${isAuth}"/>

        <h2 class="text-xl font-semibold text-gray-800 mb-4">Filters</h2>
        <form th:action="@{/posts}" method="GET" id="posts-filter-form">
            <!-- Search -->
            <div class="mb-4">
                <label for="query" class="block text-gray-600 font-medium mb-1">Search</label>
                <input
                        th:value="${filter.query}"
                        type="text"
                        id="query"
                        name="query"
                        placeholder="Enter keywords"
                        class="w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300 focus:outline-none"
                />
            </div>
            <!-- Country -->
            <div class="mb-4">
                <label for="country" class="block text-gray-600 font-medium mb-1">Country</label>
                <input
                        th:value="${filter.country}"
                        list="countries"
                        id="country"
                        name="country"
                        placeholder="Choose country"
                        class="w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300 focus:outline-none" />
                <datalist id="countries">
                    <option th:each="country : ${filterCountries}" th:value="${country}" th:text="${country}">Option</option>
                </datalist>
            </div>
            <!-- City -->
            <div class="mb-4">
                <label for="city" class="block text-gray-600 font-medium mb-1">City</label>
                <input
                        th:value="${filter.city}"
                        type="text"
                        id="city"
                        name="city"
                        placeholder="Enter city"
                        class="w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300 focus:outline-none"
                />
            </div>
            <!-- Price Range -->
            <div class="mb-4 grid grid-cols-2 gap-4">
                <div>
                    <label for="priceMin" class="block text-gray-600 font-medium mb-1">Price Min</label>
                    <input
                            th:value="${filter.priceMin}"
                            type="number"
                            id="priceMin"
                            name="priceMin"
                            placeholder="Min"
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300 focus:outline-none"
                    />
                </div>
                <div>
                    <label for="priceMax" class="block text-gray-600 font-medium mb-1">Price Max</label>
                    <input
                            th:value="${filter.priceMax}"
                            type="number"
                            id="priceMax"
                            name="priceMax"
                            placeholder="Max"
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300 focus:outline-none"
                    />
                </div>
            </div>
            <!-- Apply Button -->
            <div class="mb-4">
                <button type="submit"
                        class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition">
                    Apply
                </button>
            </div>
            <div class="mb-4">
                <button type="button"
                        id="clear-filters-button"
                        class="w-full bg-gray-500 text-white py-2 rounded-md transition">
                    Clear
                </button>
            </div>
        </form>

        <!-- Divider -->
        <hr class="my-6 border-gray-300"/>

        <h3 class="text-xl font-semibold text-gray-800 mb-4">Additional</h3>
        <!-- Additional Criteria -->
        <div>
            <button
                    onclick="findNearestPosts()"
                    type="button"
                    class="w-full text-blue-600 border border-blue-500 py-2 hover:bg-blue-100 rounded-md">
                Nearest Posts
            </button>
        </div>
    </aside>
</th:block>
